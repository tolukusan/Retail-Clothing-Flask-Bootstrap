{% extends "base.html" %}
{% block title %}Your Shopping Basket{% endblock %}

{% block content %}
<div class="cart-container">
    <!-- Cart Header -->
    <div class="cart-header">
        <div class="cart-header-icon">
            <i class="bi bi-cart3"></i>
        </div>
        <h1 class="cart-title">Your Shopping Basket</h1>
        <p class="cart-subtitle">Review and manage your selected items</p>
    </div>

    {% if cart_data %}
    <div class="row g-4">
        <!-- Left Column: Cart Items -->
        <div class="col-lg-8">
            <div class="cart-items-section">
                <div class="cart-items-header">
                    <h3><i class="bi bi-bag-check"></i> Cart Items ({{ cart_data|length }})</h3>
                </div>

                {% for data in cart_data %}
                {% set item = data.item %}
                {% set product = data.product %}
                <div class="cart-item-card">
                    <!-- Product Image & Info -->
                    <div class="cart-item-main">
                        <div class="cart-item-image">
                            <img src="{{ url_for('static', filename=product.image_url) }}" 
                                 alt="{{ product.name }}">
                        </div>
                        
                        <div class="cart-item-details">
                            <a href="{{ url_for('main.product_detail', prod_id=product.prod_id) }}" 
                               class="cart-item-name">{{ product.name }}</a>
                            <div class="cart-item-category">
                                <i class="bi bi-tag"></i> {{ product.category|capitalize }}
                            </div>
                            <div class="cart-item-price-mobile">
                                ¬£{{ product.price|round(2) }} each
                            </div>
                        </div>
                    </div>

                    <!-- Quantity Controls -->
                    <div class="cart-item-quantity">
                        <label class="quantity-label">Quantity</label>
                        <form method="POST" 
                              action="{{ url_for('cart.update_cart_item_quantity', cart_item_id=item.cart_item_id) }}" 
                              class="quantity-form">
                            <div class="quantity-controls-cart">
                                <button type="button" class="qty-btn-cart qty-decrease-cart" 
                                        onclick="decreaseCartQty('{{ item.cart_item_id }}')">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <input type="number" 
                                       id="qty_{{ item.cart_item_id }}"
                                       name="qty" 
                                       value="{{ item.qty }}" 
                                       min="1" 
                                       max="{{ product.stock_level }}"
                                       class="qty-input-cart" 
                                       readonly>
                                <button type="button" class="qty-btn-cart qty-increase-cart" 
                                        onclick="increaseCartQty('{{ item.cart_item_id }}', {{ product.stock_level }})"> 
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <button type="submit" class="update-qty-btn">
                                <i class="bi bi-arrow-clockwise"></i> Update
                            </button>
                        </form>
                    </div>

                    <!-- Price Info -->
                    <div class="cart-item-pricing">
                        <div class="item-unit-price">
                            <span class="price-label">Unit Price</span>
                            <span class="price-value">¬£{{ product.price|round(2) }}</span>
                        </div>
                        <div class="item-total-price">
                            <span class="price-label">Total</span>
                            <span class="price-value total">¬£{{ data.item_total|round(2) }}</span>
                        </div>
                    </div>

                    <!-- Remove Button -->
                    <div class="cart-item-actions">
                        <form method="POST" action="{{ url_for('cart.remove_from_cart', cart_item_id=item.cart_item_id) }}">
                            <button type="submit" class="remove-item-btn" title="Remove Item">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}

                <!-- Continue Shopping Button -->
                <div class="continue-shopping-section">
                    <a href="{{ url_for('main.product_list') }}" class="continue-shopping-btn">
                        <i class="bi bi-arrow-left"></i>
                        <span>Continue Shopping</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Right Column: Order Summary -->
        <div class="col-lg-4">
            <div class="order-summary-card">
                <div class="summary-header">
                    <i class="bi bi-receipt"></i>
                    <h3>Order Summary</h3>
                </div>

                <div class="summary-details">
                    <div class="summary-row">
                        <span class="summary-label">
                            Subtotal ({{ cart_data|length }} item{% if cart_data|length != 1 %}s{% endif %})
                        </span>
                        <span class="summary-value">¬£{{ subtotal|round(2) }}</span>
                    </div>
                    
                    <div class="summary-row">
                        <span class="summary-label">Shipping</span>
                        <span class="summary-value shipping">
                            {% if shipping > 0 %}
                                ¬£{{ shipping|round(2) }}
                            {% else %}
                                <span class="free-badge">Free</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="summary-divider"></div>
                    
                    <div class="summary-row total-row">
                        <span class="summary-label">Grand Total</span>
                        <span class="summary-value grand-total">¬£{{ grand_total|round(2) }}</span>
                    </div>
                </div>

                <!-- Payment Method Form -->
                <form method="POST" action="{{ url_for('cart.checkout') }}" class="checkout-form">
                    <div class="payment-method-section">
                        <label for="payment_method" class="payment-label">
                            <i class="bi bi-credit-card"></i> Payment Method
                        </label>
                        <select class="payment-select" id="payment_method" name="payment_method" required>
                            <option value="">Select Payment Method</option>
                            <option value="Wallet">
                                üí≥ Wallet (¬£{{ current_user.wallet_balance|round(2) }} available)
                            </option>
                            <option value="Credit Card">üí≥ Credit Card</option>
                            <option value="Debit Card">üí≥ Debit Card</option>
                            <option value="PayPal">üÖøÔ∏è PayPal</option>
                            <option value="Bank Transfer">üè¶ Bank Transfer</option>
                        </select>
                        <div class="payment-note">
                            <i class="bi bi-info-circle"></i>
                            For demo purposes only - no real payments processed
                        </div>
                    </div>
                    
                    <button type="submit" class="checkout-btn">
                        <i class="bi bi-lock-fill"></i>
                        <span>Proceed to Checkout</span>
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </form>

                <!-- Security Badges -->
                <div class="security-badges">
                    <div class="security-badge">
                        <i class="bi bi-shield-check"></i>
                        <span>Secure Checkout</span>
                    </div>
                    <div class="security-badge">
                        <i class="bi bi-lock-fill"></i>
                        <span>SSL Encrypted</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty Cart State -->
    <div class="empty-cart-state">
        <div class="empty-cart-icon">
            <i class="bi bi-cart-x"></i>
        </div>
        <h2 class="empty-cart-title">Your Basket is Empty!</h2>
        <p class="empty-cart-text">Looks like you haven't added anything to your basket yet. Start shopping to fill it up!</p>
        <a href="{{ url_for('main.product_list') }}" class="start-shopping-btn">
            <i class="bi bi-bag-heart"></i>
            <span>Start Shopping Now</span>
            <i class="bi bi-arrow-right"></i>
        </a>
    </div>
    {% endif %}
</div>

<script>
function decreaseCartQty(itemId) {
    const input = document.getElementById('qty_' + itemId);
    let value = parseInt(input.value);
    if (value > 1) {
        input.value = value - 1;
    }
}

function increaseCartQty(itemId, maxStock) {
    const input = document.getElementById('qty_' + itemId);
    let value = parseInt(input.value);
    if (value < maxStock) {
        input.value = value + 1;
    }
}
</script>
{% endblock %}